name: Deploy Gaffer On Kind
on:
  workflow_dispatch:
  # Triggers the workflow to run at at 0900 Monday and Thursday day each week 
  schedule:
  - cron: "0 9 * * 1,4"
jobs:
  Build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: 
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Build Images
        run: ./cd/build_images.sh
      
      - name: Build integration test image 
        run: docker-compose ./docker/gaffer-integration-tests/ -f ./docker/gaffer-integration-tests/docker-compose.yaml build  
      
      - name: Install subcharts
        run: ./cd/install_dependencies.sh

      - name: Deploy to Kubernetes
        run: ./cd/deploy_to_kind.sh

      - name: Load integration test image 
        run: kind load docker-image gchq/gaffer-integration-test:develop  
       
          	          
      - name: Send success message to ms teams
        if: ${{ success() }}
        uses: fjogeleit/http-request-action@master
        with:
           url: ${{secret.WORKFLOW_URL}}
           method: 'POST'
           contentType: "application/json"
           data: "{'message': 'Integration Tests passed'}"
      
      - name: Send failure message to ms teams
        if: ${{ failure() }}
        uses: fjogeleit/http-request-action@master
        with:
           url: ${{secret.WORKFLOW_URL}}
           method: 'POST'
           contentType: "application/json"
           data: "{'message': 'Integration Tests failed'}"
